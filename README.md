# Транслятор и модель

- P33081, Кочнев Роман.
- `asm | acc | neum | hw | instruction | binary | port | mem | pstr | prob2 | spi`
- Без усложнения

## Язык программирования

### Синтаксис

    Форма Бэкуса-Наура:

```ebnf
<правпосл>::=<пусто> | (<правпосл>) | <правпосл><правпосл>
<условный оператор if> ::= if <булево выражение> then <оператор> [else <оператор>]
<булево выражение> ::= "NOT" <булево выражение>
    | <булево выражение> <логическая операция> <булево выражение>
    | <выражение> <операция сравнения> <выражение>
<логическая операция> ::= "OR" | "AND"
<выражение> ::= <переменная> | <строка> | <символ>
<операция сравнения> ::= "=" | "<" | ">"
```

# Описание

В программе каждая строка с текстом представляет один из следующих элементов:

## Команда с адресом

- Возможно наличие метки в начале
- Строка содержит название команды и адрес операнда, разделённые пробелом

## Команда без адреса

- Может включать метку в начале
- Строка состоит только из названия команды

## Константа

- Может иметь метку в начале
- Обозначается как `word:` с последующей константой
- Константа - это 16-битное число со знаком или строка (указывается длина и сама строка)

## Адрес

- Обозначается словом `org` и числовым адресом в десятичной форме

# Семантика

- Данные доступны глобально
- Поддерживаются целочисленные значения от $-2^{31}$ до $2^{31}-1$
- Поддерживаются строковые значения с указанием длины и заключённые в кавычки
- Код выполняется последовательно

- Необходимо наличие метки `start:`, указывающей на первую исполняемую инструкцию (не может указывать на константу)
- Название метки не должно совпадать с названием команды и не начинаться с цифры
- Метки и операнды расположены на одной строке с командами
- Пустые строки и пробелы в начале/конце строки не учитываются
- Текст после `';'` считается комментарием

## Организация памяти

- Общая память для команд и данных
- Размер слова - `32` бита
- `2^11` ячеек памяти
- Ячейка `0` - для вектора прерывания устройства ввода
- Адрес `2045` - начальный указатель стека (стек растёт вверх)
- Адрес `2046` - для устройства ввода
- Адрес `2047` - для устройства вывода

### Виды адресации

- **Прямая**: адрес ячейки, значение которой будет использовано как операнд
- **Косвенная**: адрес, по которому лежит адрес операнда

### Регистры

- Аккумулятор (AC)
- Счетчик команд (IP)
- Указатель стека (SP)
- Регистр состояния (PS) с битами состояния:
    - C, Z, N - флаги
    - Бит запроса прерывания
    - Бит разрешения/запрета прерываний
- Регистр данных (DR)
- Регистр адреса (AR)

# Система команд

## Особенности процессора

- 32-битное машинное слово
- 11-битные беззнаковые адреса как аргументы команд
## Первые 4 бита - позволяют задать тип аргумента
- 1 - Показывает длину текстовой переменной
- 2 - Ссылка на адрес
- 3 - Целочисленная переменная 

## Циклы выполнения команды

1. Выборка команды: извлечение команды из памяти по адресу счетчика команд
2. Выборка операнда (для команд с адресом): помещение адреса операнда в регистр данных, затем в регистр адреса, и
   извлечение значения операнда в регистр данных
3. Исполнение: выполнение команды, запись результатов в аккумулятор
4. Прерывание: проверка на запрос прерывания

### Набор инструкций

load store add sub jmp cmp jmn jmnn jmc jmnc jmz jmnz asl asr dec inc cla hlt iret push pop di ei nop
|

### Кодирование инструкций

- Машинный код преобразуется в бинарный файл.
- Одна инструкция - 4 байта или 32 бита.

## Транслятор

# Этапы трансляции (функция `translate`)

1. **Выделение меток из кода, проверка их корректности**  
   Метки не должны совпадать с названиями команд и не должны дублироваться.

2. **Парсинг кода построчно, определение типа команды**  
   Определяются типы команд: адресная, безадресная, константа.

3. **Генерация машинного кода в зависимости от типа команды**

## Правила генерации машинного кода

- Метки не сохраняются в машинном коде. Вместо этого, метки, использованные в качестве операнда, преобразуются к адресам
  команд.

## DataPath

Реализован в классе `DataPath`.

- `data_memory` — однопортовая память (можно либо читать, либо писать).
- `registers`

Сигналы, реализованные в виде методов класса:

- `set_reg` — зафиксировать значение в указанном регистре.
- `rd` — чтение данных из `mem[AR]` в регистр `DR`.
- `wr` — запись данных из регистра `DR` в `mem[AR]`.

Арифметико-логическое устройство (АЛУ) реализовано в отдельном классе:

- Метод `calc` выполняет арифметико-логические операции над одним или двумя входными аргументами.
- В результате операций устанавливаются флаги:
    - `Z` — значение в аккумуляторе равно 0.
    - `N` — значение в аккумуляторе отрицательное.
    - `C` — произошло переполнение (перенос из 16-го бита).

### ControlUnit

Реализован в классе `ControlUnit`.

- Метод `decode_and_execute_instruction` моделирует выполнение полного цикла инструкции (выборка инструкции, операнда,
  исполнение).
- После завершения цикла исполнения проверяется наличие запроса на прерывание и разрешены ли прерывания. Если условия
  выполняются, вызывается метод `process_interrupt`.

Особенности работы модели:

- Цикл симуляции в функции `simulation`.
- Шаг моделирования соответствует одному такту процессора с выводом состояния в журнал (используется `logging`).
- Количество инструкций для моделирования ограничено.
- Моделирование останавливается при:
    - Превышении лимита инструкций.
    - Исключениях `Incorrect unary operation` или `Incorrect binary operation`.
    - Выполнении инструкции `hlt`.

Обработка прерываний в методе `process_interrupt`:

- Сохранение текущих значений IP и PS на стеке.
- Запись в IP адреса из вектора прерываний.
- Выполнение команд для обработки прерывания. Возврат в основную программу при выполнении `iret`.

Проверка запроса прерывания осуществляется после каждого цикла исполнения команды.

- Программист должен самостоятельно управлять разрешением и запретом прерываний.

## Тестирование

- pytest --update-goldens для запуска тестов

Выводится листинг всех регистров после каждой команды согласно варианту.

- Значения всех регистров, кроме PS и CR выводятся в десятичном формате
- Значение регистра `PS` выводится в двоичном формате для удобного определения флагов, наличия запроса прерываний и тд.
- В качестве значения регистра `CR`выводятся код оператора и операнд (при наличии)
- Если в какой-то регистр записан символ, в листинге выводится его код

Также в лог выводятся события вида `INPUT symbol` и `OUTPUT symbol`

Пример проверки исходного кода:

``` shell
platform win32 -- Python 3.12.0, pytest-7.4.4, pluggy-1.3.0 -- C:\Users\pomat\AppData\Local\pypoetry\Cache\virtualenvs\poma12390-mvNxXYGT-py3.12\Scripts\python.exe
cachedir: .pytest_cache
rootdir: C:\Users\pomat\Documents\3course\АК\csa-lab-3-poma12390
configfile: pyproject.toml
plugins: golden-0.2.2
collected 5 items

invegration_test.py::test_translator_and_machine[golden/cat.yml] PASSED                                                                                                      [ 20%]
invegration_test.py::test_translator_and_machine[golden/hellouser.yml] PASSED                                                                                                [ 40%]
invegration_test.py::test_translator_and_machine[golden/hi.yml] PASSED                                                                                                       [ 60%]
invegration_test.py::test_translator_and_machine[golden/poppush.yml] PASSED                                                                                                  [ 80%]
invegration_test.py::test_translator_and_machine[golden/prob2.yml] PASSED                                                                                                    [100%]

================================================================================ 5 passed in 0.77s ================================================================================

```

